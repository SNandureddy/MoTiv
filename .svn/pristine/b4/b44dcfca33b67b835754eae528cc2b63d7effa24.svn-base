//
//  DashBoardVC.swift
//  MoTiv
//
//  Created by ios2 on 04/12/18.
//  Copyright Â© 2018 MoTiv. All rights reserved.
//

import UIKit
import SwiftChart

class DashBoardVC: BaseVC {
    
    //MARK: IBOutlets
    @IBOutlet weak var totalSalesAmountLabel: UILabel!
    @IBOutlet weak var totalSalesBaseView: UIView!
    @IBOutlet weak var tableView: UITableView!
    
    //MARK: Variables
    var selectedTag = 1         // 1=>hourly,2=>daily,3=>weekly,4=>monthly
    var selectedIndex = Int()
    
    //MARLK: Life cycle
    override func viewDidLoad() {
        super.viewDidLoad()
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        getDashboardData(chartType: 1)    // 1=>sales_chart,2=>check_in_summary
//        getDashboardData(chartType: 2)
        customiseUI()
    }
    
    //MARK: Private Methods
    private func customiseUI(){
        setTitle(title: kDashboard)
        self.totalSalesBaseView.set(radius: 14.0)
    }
}



//MARK: UITableview Datasource
extension DashBoardVC: UITableViewDataSource, UITableViewDelegate {
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return 2
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        if indexPath.row == 0 {
            let cell = tableView.dequeueReusableCell(withIdentifier: kSalesSummaryCell, for: indexPath) as! SalesSummaryCell
            cell.hourlyBuytton.addTarget(self, action: #selector(self.timeSelectionAction(sender:)), for: .touchUpInside)
            cell.dailyButton.addTarget(self, action: #selector(self.timeSelectionAction(sender:)), for: .touchUpInside)
            cell.weeklyBUtton.addTarget(self, action: #selector(self.timeSelectionAction(sender:)), for: .touchUpInside)
            cell.monthlyButton.addTarget(self, action: #selector(self.timeSelectionAction(sender:)), for: .touchUpInside)
            cell.salesGraphView.removeAllSeries()
            var seriesData = [Double(0)]
            seriesData += EventVM.shared.dashboardRecordsArray?.map({Double($0.bought ?? 0)}) ?? [Double]()
            let series = ChartSeries(seriesData)
            series.color = UIColor.motivColor.baseColor.color()
            cell.salesGraphView.add(series)
            if selectedTag == 1 {
                cell.salesGraphView.xLabels = [0, 3, 6, 9, 12, 15, 18, 21, 24]
            } else if selectedTag == 2 {
                cell.salesGraphView.xLabels = [0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30]
            } else if selectedTag == 3 {
                cell.salesGraphView.xLabels = [0, 1, 2, 3, 4, 5, 6]
            } else {
                cell.salesGraphView.xLabels = [0, 2, 4, 6, 8, 10, 12]
            }
            cell.salesGraphView.showYLabelsAndGrid = false
            cell.salesGraphView.showXLabelsAndGrid = false
            cell.salesTableView.reloadData()
            (cell.viewWithTag(1) as! UIButton).backgroundColor = UIColor.motivColor.baseColor.color()
            (cell.viewWithTag(2) as! UIButton).backgroundColor = UIColor.motivColor.baseColor.color()
            (cell.viewWithTag(3) as! UIButton).backgroundColor = UIColor.motivColor.baseColor.color()
            (cell.viewWithTag(4) as! UIButton).backgroundColor = UIColor.motivColor.baseColor.color()
            (cell.viewWithTag(selectedTag) as! UIButton).backgroundColor = UIColor.motivColor.darkBaseColor.color()
            let height = cell.salesTableView.contentSize.height
            cell.salesTableViewHeight.constant = height
            return cell
        }else {
            let cell = tableView.dequeueReusableCell(withIdentifier: kCheckInSummaryCell) as! CheckInSummaryCell
            return cell
        }
    }
    
    @objc func timeSelectionAction(sender: UIButton) {
        selectedTag = sender.tag
        getDashboardData(chartType: 1)
//        getDashboardData(chartType: 2)
        tableView.reloadData()
    }
}

//MARK: - API Calls
extension DashBoardVC {
    func getDashboardData(chartType: Int){
        var dict = JSONDictionary()
        dict[APIKeys.kEventID] = EventVM.shared.checkInEventDetailArray?[selectedIndex].eventID
        dict[APIKeys.kType] = self.selectedTag
        dict[APIKeys.kChartType] = chartType
        EventVM.shared.getDashboardData(dict: dict){ (message, error) in
            if error != nil{
                self.showErrorMessage(error: error)
            } else{
                self.totalSalesAmountLabel.text = "\(EventVM.shared.grossSales ?? 0)"
                self.tableView.reloadData()
            }
        }
    }
}
