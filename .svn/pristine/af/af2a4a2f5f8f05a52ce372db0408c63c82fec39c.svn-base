//
//  U_HomeVC.swift
//  MoTiv
//
//  Created by Deftsoft on 06/12/18.
//  Copyright © 2018 MoTiv. All rights reserved.
//

import UIKit
import SDWebImage

enum EventTime :String {
    case now = "current"
    case future = "upcoming"
    case favourite = "favourite"
//    current,past,upcoming,favourite,invitiations
}

class U_HomeVC: BaseVC {
    // MARK: - IBOutlets
    
    @IBOutlet weak var eventsTableView: UITableView!
    @IBOutlet weak var ticketsButton: UIButton!
    @IBOutlet weak var filterButton: UIButton!
    @IBOutlet weak var chatButton: UIButton!
    @IBOutlet weak var questionButton: UIButton!
    @IBOutlet weak var nowButton: UIButton!
    @IBOutlet weak var futureButton: UIButton!
    @IBOutlet weak var favoriteButton: UIButton!
    
    // MARK: - Variables
    var isFirstTime = true
    var workItem: DispatchWorkItem!
    var workItem1: DispatchWorkItem!
    var workItem2: DispatchWorkItem!
    var workItem3: DispatchWorkItem!
    var workItem4: DispatchWorkItem!
    var eventList: [EventDetail]?
    var selectedTime: EventTime = .now
    var indexofPage:Int = 1
    
    // MARK: - Class life cycle
    override func viewDidLoad() {
        super.viewDidLoad()
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        self.customizeUI()
        getEventList()
    }
    override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
    }
    
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
//        workItem = DispatchWorkItem {
//            self.showPopover(type: .down, title: kSupportPop, sender: self.questionButton)
//        }
        workItem1 = DispatchWorkItem {
            self.showPopover(type: .down, title: kFilterPop, sender: self.filterButton)
        }
        workItem2 = DispatchWorkItem {
            self.showPopover(type: .down, title: kChatPop, sender: self.chatButton)
        }
        self.showPopover(type: .down, title: kFilterPop, sender: ticketsButton)
        //DispatchQueue.main.asyncAfter(deadline: .now()+2, execute: workItem)
        DispatchQueue.main.asyncAfter(deadline: .now()+4, execute: workItem1)
        DispatchQueue.main.asyncAfter(deadline: .now()+6, execute: workItem2)
    }
    
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        //workItem.cancel()
        workItem1.cancel()
        workItem2.cancel()
        workItem3.cancel()
        workItem4.cancel()
    }

    
    // MARK: - Private functions
    private func customizeUI() {
        indexofPage = 1
        self.hideNavigationBar()
        self.eventsTableView.reloadData()
    }
    // MARK: - IBActions
    
    @IBAction func ticketsButtonAction(_ sender: Any) {
       

        let ticketvc = self.storyboard?.instantiateViewController(withIdentifier: kMyTicketsVC) as! MyTicketsVC
        self.show(ticketvc, sender: self)
    }
    
    @IBAction func filterButtonAction(_ sender: Any) {
        let storyboard = UIStoryboard.init(storyboard: .Home)
        let nextObj = storyboard.instantiateViewController(withIdentifier: kU_HomeFilterVC)
        let navController = UINavigationController(rootViewController: nextObj)
        self.navigationController?.present(navController, animated: true, completion: nil)
    }
    @IBAction func chatButtonAction(_ sender: Any) {
        let storyboard = UIStoryboard.init(storyboard: .Chat)
        let vc = storyboard.instantiateViewController(withIdentifier: kInboxVC)as! InboxVC
        self.navigationController?.pushViewController(vc, animated: true)
    }
    
    @IBAction func nowButtonAction(_ sender: Any) {
        futureButton.backgroundColor = UIColor.clear
        favoriteButton.backgroundColor = UIColor.clear
        nowButton.backgroundColor = UIColor.motivColor.darkBaseColor.color()
        self.selectedTime = .now
        eventList?.removeAll()
        self.eventsTableView.reloadData()
        self.getEventList()
    }
    @IBAction func futureButtonAction(_ sender: Any) {
        futureButton.backgroundColor = UIColor.motivColor.darkBaseColor.color()
        favoriteButton.backgroundColor = UIColor.clear
        nowButton.backgroundColor = UIColor.clear
        self.selectedTime = .future
        eventList?.removeAll()
        self.eventsTableView.reloadData()
        self.getEventList()
    }
    
    @IBAction func favoriteButtonAction(_ sender: Any) {
        futureButton.backgroundColor = UIColor.clear
        favoriteButton.backgroundColor = UIColor.motivColor.darkBaseColor.color()
        nowButton.backgroundColor = UIColor.clear
        self.selectedTime = .favourite
        eventList?.removeAll()
        self.eventsTableView.reloadData()
        self.getEventList()
    }
    //MARK: - Private func
    func setData() -> JSONDictionary {
        var dict = JSONDictionary()
        dict[APIKeys.kEventTime] = selectedTime.rawValue
        dict[APIKeys.kPage] = indexofPage
        return dict
    }
    
}

//MARK: UITableView Delegates & Datasources
extension U_HomeVC: UITableViewDataSource{
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return eventList?.count ?? 0
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: kU_HomeCell, for: indexPath) as! U_HomeCell
        cell.selectionStyle = .none
        cell.playButton.isHidden = true
        cell.eventNameLabel.text = eventList?[indexPath.row].eventName
        cell.timeLabel.text = eventList?[indexPath.row].eventDate?.dateFromString(format: .time, type: .local).stringFromDate(format: .time, type: .local)
        cell.priceLabel.text = "£ \(eventList?[indexPath.row].ticketAmount ?? 0)"
        cell.eventImageView?.sd_setImage(with: URL(string: eventList?[indexPath.row].eventImageURL ?? ""), placeholderImage: nil, options: .cacheMemoryOnly, completed: nil)
        
        if indexPath.row == 0 && isFirstTime {
            isFirstTime = false
            workItem3 = DispatchWorkItem {
                self.showPopover(type: .down, title: kFavouritePop, sender: (cell.viewWithTag(1) as! UIButton))
            }
            workItem4 = DispatchWorkItem {
                self.showPopover(type: .down, title: kSharePop, sender: (cell.viewWithTag(2) as! UIButton))
            }
            DispatchQueue.main.asyncAfter(deadline: .now()+1, execute: workItem3)
            DispatchQueue.main.asyncAfter(deadline: .now()+4, execute: workItem4)
        }
        return cell
    }
    
}

extension U_HomeVC: UITableViewDelegate {
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let detailvc = self.storyboard?.instantiateViewController(withIdentifier: kEventDetails) as! EventDetailVC
        detailvc.selectedIndex = indexPath.row
        self.navigationController?.show(detailvc, sender: self)
    }
    
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return UITableViewAutomaticDimension
    }
}

//MARK: UIScrollViewDelegate
extension U_HomeVC {
    func scrollViewDidEndDecelerating(_ scrollView: UIScrollView)
    {
        if (eventsTableView!.contentOffset.y + eventsTableView!.frame.height) >= (eventsTableView!.contentSize.height - 50) {
            if (eventList?.count ?? 0) > 0 {
                    indexofPage = indexofPage + 1
                getEventList()
            }
        }
    }
}


//MARK: - API Calls
extension U_HomeVC {
  
    func getEventList(){
        if indexofPage == 1 {
            EventVM.shared.eventDetailArray?.removeAll()
            self.eventList?.removeAll()
            self.eventsTableView.reloadData()
        }
        EventVM.shared.getEventList(dict: setData()){ (message, error) in
            if error != nil{
                self.indexofPage = self.indexofPage - 1
                self.showErrorMessage(error: error)
            } else{
                if self.indexofPage == (EventVM.shared.eventLastPage ?? 0) {
                    self.indexofPage = self.indexofPage - 1
                }
                self.eventList = EventVM.shared.eventDetailArray
                self.eventsTableView.reloadData()
            }
        }
    }
}
